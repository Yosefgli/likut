<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <title>מחסן → מדף</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon.svg" type="image/svg+xml" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #f6f7f9; color:#111; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.08); }
    h1 { font-size: 20px; margin: 0 0 10px; }
    h2 { font-size: 16px; margin: 0 0 12px; }
    .muted { color: #666; font-size: 13px; }
    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex: 1; }
    button {
      border: 0; border-radius: 12px; padding: 14px 12px;
      font-weight: 700; cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      background:#111; color:#fff;
    }
    button.secondary { background:#e9ebef; color:#111; font-weight: 700; }
    button.danger { background:#b00020; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    button.install { background:#2563eb; }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 14px 12px;
      border-radius: 12px;
      border: 1px solid #d9dde5;
      font-size: 16px;
      outline: none;
      background: #fff;
    }
    .grid10 { display:grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
    .grid10 button { background:#0b5; }
    .hidden { display:none !important; }
    .status { margin-top: 10px; font-size: 13px; }
    .status.ok { color: #0a7; }
    .status.err { color: #b00020; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align:right; padding: 10px 8px; border-bottom: 1px solid #eee; font-size: 14px; }
    th { color:#444; font-size: 13px; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; background:#eef2ff; font-size: 12px; }
    .topbar { display:flex; justify-content: space-between; align-items:center; gap:10px; margin-bottom: 12px; }
    .topbar .pill { background:#fff; border:1px solid #eee; }
    .summary-header { display:flex; align-items:center; justify-content: space-between; gap: 12px; }
    .summary-sort { display:flex; align-items:center; gap: 8px; font-size: 13px; color: #444; }
    .summary-sort select { padding: 8px 10px; border-radius: 10px; border: 1px solid #d9dde5; background: #fff; font-size: 14px; }
    .summary-row { cursor: pointer; }
    .summary-row.flagged { background: #ffe3ef; }
    .summary-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: #0b5; }
    .qty-cell { text-decoration: underline; text-underline-offset: 3px; cursor: pointer; }
    .confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 20;
    }
    .confirm-card { background: #fff; border-radius: 14px; padding: 16px; width: min(360px, 100%); box-shadow: 0 10px 24px rgba(0,0,0,.18); }
    .confirm-actions { display: flex; gap: 10px; margin-top: 12px; }
    .confirm-actions button { flex: 1; }
    .confirm-actions .confirm-yes { background:#ff5fa2; color:#fff; }
    .confirm-actions .confirm-yes.confirm-yes-green { background:#6ee7b7; color:#0f5132; }
    .hidden-column { display: none; }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="pill">מצב: <span id="modeLabel">התחלה</span></div>
      <div class="pill">Task: <span id="taskLabel">—</span></div>
    </div>

    <!-- START -->
    <section id="screenStart" class="card">
      <h1>התחלת משימה</h1>
      <p class="muted">לחץ כדי לפתוח משימה חדשה. אם יש משימה פתוחה במכשיר, נמשיך אותה אוטומטית.</p>

      <div style="margin-top:12px;">
        <label class="muted">שם מחסנאי / מכשיר (לא חובה)</label>
        <input id="createdBy" type="text" placeholder="לדוגמה: יוסי / מחסן-1" autocomplete="off" />
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnStart">התחל משימה</button>
        <button id="btnResume" class="secondary">המשך משימה קיימת</button>
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="btnInstall" class="install hidden">התקן כאפליקציה</button>
      </div>
      <div id="startStatus" class="status"></div>
    </section>

    <!-- SCAN -->
    <section id="screenScan" class="card hidden">
      <h1>סריקה</h1>
      <p class="muted">סרוק ברקוד עם הסורק. השדה פעיל ומוכן לסריקה.</p>

      <div class="row" style="margin-top:12px;">
        <input id="barcode" type="text"
               inputmode="text"
               autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
               placeholder="סרוק כאן..." />
        <button id="btnManual" class="secondary" style="flex:0 0 160px;">הקלדת ברקוד ידנית</button>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnManualProduct" class="secondary">הזנת מוצר ידנית</button>
      </div>

      <div id="manualProductModal" class="confirm-overlay hidden">
        <div class="confirm-card">
          <h2>הוספת מוצר ידנית</h2>
          <div style="margin-top:10px;" class="muted">שם מוצר</div>
          <input id="manualProductName" type="text" autocomplete="off" placeholder="שם מוצר" />
          <div style="margin-top:10px;" class="muted">כמות</div>
          <input id="manualQty" type="number" min="1" max="999" inputmode="numeric" placeholder="כמות" />
          <div style="margin-top:10px;" class="muted">מדף</div>
          <input id="manualShelf" type="text" autocomplete="off" placeholder="מדף" />
          <div style="margin-top:10px;" class="muted">מחסן</div>
          <input id="manualWarehouse" type="text" autocomplete="off" placeholder="מחסן" />
          <div class="confirm-actions">
            <button id="manualSave">אישור</button>
            <button id="manualCancel" class="secondary">ביטול</button>
          </div>
        </div>
      </div>

      <div id="scanStatus" class="status"></div>
      <!-- NUMPAD (Manual input without phone keyboard) -->
<div id="numpad" class="hidden" style="margin-top:12px;">
  <h2>הקלדה ידנית</h2>

  <div style="margin-bottom:10px;" class="muted">
    הקלד מספרים בעזרת הכפתורים (המקלדת של הטלפון לא תיפתח).
  </div>

  <div class="grid10" id="padGrid"></div>

  <div class="row" style="margin-top:12px;">
    <button id="padBack" class="secondary">מחיקה</button>
    <button id="padClear" class="secondary">נקה</button>
    <button id="padOk">אישור</button>
  </div>

  <div class="row" style="margin-top:12px;">
    <button id="padClose" class="danger">סגור</button>
  </div>
</div>


      <!-- Qty picker -->
      <div id="qtyPanel" class="hidden" style="margin-top:14px;">
        <h2>בחר כמות (1–10)</h2>
        <div id="productPreview" class="muted" style="margin-bottom:10px;"></div>
        <div class="grid10" id="qtyGrid"></div>
        <div class="row" style="margin-top:12px;">
          <button id="btnCancelQty" class="secondary">ביטול</button>
          <button id="btnFinishFromScan" class="danger">סיום</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnFinish" class="danger">סיום</button>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="screenSummary" class="card hidden">
      <div class="summary-header">
        <h1>סיכום פריטים</h1>
        <label class="summary-sort">
          מיון:
          <select id="summarySort">
            <option value="warehouse">מחסן</option>
            <option value="shelf">מדף</option>
            <option value="product">מוצר</option>
          </select>
        </label>
      </div>
      <p class="muted">פה תראה את כל מה שנסרק במשימה.</p>

      <div class="row" style="margin-top:12px;">
        <button id="btnAddMore" class="secondary">הוסף מוצר</button>
        <button id="btnDone" class="danger">סיימתי (איפוס)</button>
      </div>

      <div id="summaryStatus" class="status"></div>

      <table id="summaryTable">
        <thead>
          <tr>
            <th>מחסן</th>
            <th id="checklistHeader" class="hidden-column">צ'קליסט</th>
            <th>מוצר</th>
            <th>כמות</th>
            <th>מדף</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="inventoryConfirm" class="confirm-overlay hidden">
        <div class="confirm-card">
          <div id="inventoryConfirmText" class="muted"></div>
          <div class="confirm-actions">
            <button id="inventoryConfirmYes" class="confirm-yes">כן</button>
            <button id="inventoryConfirmNo" class="secondary">לא</button>
          </div>
        </div>
      </div>

      <div id="finishConfirm" class="confirm-overlay hidden">
        <div class="confirm-card">
          <div class="muted">לסיים את המשימה ולאפס?</div>
          <div class="confirm-actions">
            <button id="finishConfirmYes" class="danger">סיום</button>
            <button id="finishConfirmNo" class="secondary">ביטול</button>
          </div>
        </div>
      </div>

      <div id="qtyEditModal" class="confirm-overlay hidden">
        <div class="confirm-card">
          <div id="qtyEditTitle" class="muted">עריכת כמות</div>
          <input id="qtyEditInput" type="number" min="1" inputmode="numeric" placeholder="כמות חדשה" style="margin-top:10px;" />
          <div class="confirm-actions">
            <button id="qtyEditSave">שמור</button>
            <button id="qtyEditCancel" class="secondary">ביטול</button>
          </div>
        </div>
      </div>
    </section>

  </div>

<script>
/** =======================
 *  CONFIG
 *  ======================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyuK05nXpuQj1n56AaGvEBm4tW4pCHkyolIQz3YxXpXt6nGKGQBQY5_jeLYP5fNjlA9/exec";

// Local storage keys
const LS_TASK_ID = "wh_taskId";
const LS_CREATED_BY = "wh_createdBy";
const LS_LAST_BARCODE = "wh_lastBarcode";
const LS_MANUAL_LINES = "wh_manualLines";

function getDateTimeParts() {
  const now = new Date();
  const date = now.toISOString().slice(0, 10);
  const time = now.toTimeString().slice(0, 8);
  return { date, time };
}

/** =======================
 *  DOM
 *  ======================= */
const screenStart = document.getElementById("screenStart");
const screenScan = document.getElementById("screenScan");
const screenSummary = document.getElementById("screenSummary");

const modeLabel = document.getElementById("modeLabel");
const taskLabel = document.getElementById("taskLabel");

const createdByInput = document.getElementById("createdBy");
const btnStart = document.getElementById("btnStart");
const btnResume = document.getElementById("btnResume");
const btnInstall = document.getElementById("btnInstall");
const btnManualProduct = document.getElementById("btnManualProduct");
const manualProductModal = document.getElementById("manualProductModal");
const manualProductName = document.getElementById("manualProductName");
const manualQty = document.getElementById("manualQty");
const manualShelf = document.getElementById("manualShelf");
const manualWarehouse = document.getElementById("manualWarehouse");
const manualSave = document.getElementById("manualSave");
const manualCancel = document.getElementById("manualCancel");
const startStatus = document.getElementById("startStatus");

const barcodeInput = document.getElementById("barcode");
const btnManual = document.getElementById("btnManual");
// Numpad elements
const numpad = document.getElementById("numpad");
const padGrid = document.getElementById("padGrid");
const padBack = document.getElementById("padBack");
const padClear = document.getElementById("padClear");
const padOk = document.getElementById("padOk");
const padClose = document.getElementById("padClose");
const scanStatus = document.getElementById("scanStatus");

const qtyPanel = document.getElementById("qtyPanel");
const qtyGrid = document.getElementById("qtyGrid");
const productPreview = document.getElementById("productPreview");
const btnCancelQty = document.getElementById("btnCancelQty");
const btnFinish = document.getElementById("btnFinish");
const btnFinishFromScan = document.getElementById("btnFinishFromScan");

const btnAddMore = document.getElementById("btnAddMore");
const btnDone = document.getElementById("btnDone");
const summaryStatus = document.getElementById("summaryStatus");
const summaryTableBody = document.querySelector("#summaryTable tbody");
const summarySort = document.getElementById("summarySort");
const inventoryConfirm = document.getElementById("inventoryConfirm");
const inventoryConfirmText = document.getElementById("inventoryConfirmText");
const inventoryConfirmYes = document.getElementById("inventoryConfirmYes");
const inventoryConfirmNo = document.getElementById("inventoryConfirmNo");
const checklistHeader = document.getElementById("checklistHeader");
const finishConfirm = document.getElementById("finishConfirm");
const finishConfirmYes = document.getElementById("finishConfirmYes");
const finishConfirmNo = document.getElementById("finishConfirmNo");
const qtyEditModal = document.getElementById("qtyEditModal");
const qtyEditTitle = document.getElementById("qtyEditTitle");
const qtyEditInput = document.getElementById("qtyEditInput");
const qtyEditSave = document.getElementById("qtyEditSave");
const qtyEditCancel = document.getElementById("qtyEditCancel");

/** =======================
 *  STATE
 *  ======================= */
let taskId = localStorage.getItem(LS_TASK_ID) || "";
let pendingBarcode = "";
let pendingProduct = null; // from server response
let summaryLines = [];
let pendingInventoryToggle = null;
let deferredInstallPrompt = null;
let pendingQtyEdit = null;

/** =======================
 *  UI helpers
 *  ======================= */
function setMode(label) {
  modeLabel.textContent = label;
}

function setTaskLabel(id) {
  taskLabel.textContent = id ? id.slice(0, 8) + "…" : "—";
}

function show(el) { el.classList.remove("hidden"); }
function hide(el) { el.classList.add("hidden"); }

function goStart() {
  setMode("התחלה");
  show(screenStart); hide(screenScan); hide(screenSummary);
  setTaskLabel(taskId);
  startStatus.textContent = "";
  startStatus.className = "status";
  createdByInput.value = localStorage.getItem(LS_CREATED_BY) || "";
}

function goScan() {
  setMode("סריקה");
  hide(screenStart); show(screenScan); hide(screenSummary);
  hide(qtyPanel);
  hide(numpad);
  scanStatus.textContent = "";
  scanStatus.className = "status";
  setTaskLabel(taskId);
  armScanner();
}

function goSummary() {
  setMode("סיכום");
  hide(screenStart); hide(screenScan); show(screenSummary);
  summaryStatus.textContent = "";
  summaryStatus.className = "status";
  setTaskLabel(taskId);
}

function setStatus(el, msg, ok) {
  el.textContent = msg || "";
  el.className = "status " + (ok ? "ok" : "err");
}

/** =======================
 *  Scanner input behavior
 *  ======================= */
function armScanner() {
  // Keep it focused so scanner can type immediately
  barcodeInput.readOnly = false;
  barcodeInput.setAttribute("inputmode", "text");
  barcodeInput.value = "";
  // focus so scanner can type
  try { barcodeInput.focus({ preventScroll: true }); } catch { barcodeInput.focus(); }
}

// Manual keyboard only on demand
btnManual.addEventListener("click", () => {
  // פותח לוח מספרים פנימי במקום מקלדת של הטלפון
  show(numpad);
  buildNumpad();
});


// Capture Enter from scanner
barcodeInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    const code = (barcodeInput.value || "").trim();
    if (!code) return;
    barcodeInput.value = "";
    onBarcodeScanned(code);
  }
});

/** =======================
 *  API
 *  ======================= */
// NOTE: Apps Script sometimes expects text/plain for JSON.
async function apiPost(payload) {
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload),
  });
  // If CORS blocks, you'll see a network error.
  return res.json();
}

async function apiGet(params) {
  const url = new URL(API_URL);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
  const res = await fetch(url.toString(), { method: "GET" });
  return res.json();
}

function loadManualLinesMap() {
  try {
    return JSON.parse(localStorage.getItem(LS_MANUAL_LINES) || "{}") || {};
  } catch {
    return {};
  }
}

function getManualLines(taskIdValue) {
  const all = loadManualLinesMap();
  return Array.isArray(all[taskIdValue]) ? all[taskIdValue] : [];
}

function saveManualLines(taskIdValue, lines) {
  const all = loadManualLinesMap();
  all[taskIdValue] = lines;
  localStorage.setItem(LS_MANUAL_LINES, JSON.stringify(all));
}

function upsertManualLine(taskIdValue, line) {
  const lines = getManualLines(taskIdValue);
  const idx = lines.findIndex((x) => x.manualId === line.manualId);
  if (idx >= 0) lines[idx] = line;
  else lines.push(line);
  saveManualLines(taskIdValue, lines);
}

function removeTaskManualLines(taskIdValue) {
  const all = loadManualLinesMap();
  delete all[taskIdValue];
  localStorage.setItem(LS_MANUAL_LINES, JSON.stringify(all));
}

async function ensureTaskStarted() {
  if (taskId) return taskId;
  const createdBy = (createdByInput.value || "").trim() || "unknown";
  localStorage.setItem(LS_CREATED_BY, createdBy);
  const { date, time } = getDateTimeParts();
  const data = await apiPost({
    action: "startTask",
    createdBy,
    createdAtDate: date,
    createdAtTime: time,
  });
  if (!data.ok) throw new Error(data.error || "startTask failed");
  taskId = data.taskId;
  localStorage.setItem(LS_TASK_ID, taskId);
  setTaskLabel(taskId);
  return taskId;
}

function resetManualProductForm() {
  manualProductName.value = "";
  manualQty.value = "";
  manualShelf.value = "";
  manualWarehouse.value = "";
}

async function trySaveManualLineToSheet({ productName, qty, shelf, warehouseBin }) {
  const { date, time } = getDateTimeParts();
  const payload = {
    action: "updateLine",
    taskId,
    lineId: "",
    lineIndex: "",
    barcode: "",
    productName,
    qty,
    shelf,
    warehouseBin,
    scannedAtDate: date,
    scannedAtTime: time,
    inventory: "",
    checklist: "",
  };
  return apiPost(payload);
}

/** =======================
 *  Flow
 *  ======================= */
btnStart.addEventListener("click", async () => {
  btnStart.disabled = true;
  try {
    await ensureTaskStarted();
    setStatus(startStatus, "משימה נפתחה ✅", true);
    goScan();
  } catch (err) {
    setStatus(startStatus, "שגיאה בפתיחת משימה: " + err.message, false);
  } finally {
    btnStart.disabled = false;
  }
});

btnResume.addEventListener("click", async () => {
  // If there is a taskId in storage, just continue
  if (!taskId) {
    setStatus(startStatus, "אין משימה קיימת במכשיר. פתח משימה חדשה.", false);
    return;
  }
  setStatus(startStatus, "ממשיך משימה קיימת ✅", true);
  goScan();
});

btnInstall.addEventListener("click", async () => {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  try {
    await deferredInstallPrompt.userChoice;
  } finally {
    deferredInstallPrompt = null;
    hide(btnInstall);
  }
});

btnManualProduct.addEventListener("click", () => {
  resetManualProductForm();
  show(manualProductModal);
});

manualCancel.addEventListener("click", () => {
  hide(manualProductModal);
});

manualSave.addEventListener("click", async () => {
  const productName = (manualProductName.value || "").trim();
  const qtyInput = Number(manualQty.value || 0);
  const qty = Number.isFinite(qtyInput) && qtyInput > 0 ? qtyInput : 1;
  const shelf = (manualShelf.value || "").trim();
  const warehouseBin = (manualWarehouse.value || "").trim();

  if (!productName) {
    setStatus(scanStatus, "יש למלא לפחות שם מוצר.", false);
    return;
  }

  manualSave.disabled = true;
  manualCancel.disabled = true;
  try {
    await ensureTaskStarted();

    const saveResult = await trySaveManualLineToSheet({
      productName,
      qty,
      shelf,
      warehouseBin,
    });

    if (!saveResult?.ok) {
      throw new Error(saveResult?.error || "שמירה ידנית נכשלה");
    }

    hide(manualProductModal);
    setStatus(scanStatus, "מוצר ידני נוסף ונשמר לשיטס ✅", true);
    goScan();
  } catch (err) {
    const msg = String(err?.message || err || "");
    const hint = msg.toLowerCase().includes("unknown action")
      ? " (נראה שב־Apps Script חסרה פעולה לשמירת מוצר ידני ללא ברקוד)"
      : "";
    setStatus(scanStatus, "שגיאה בהוספה ידנית: " + msg + hint, false);
  } finally {
    manualSave.disabled = false;
    manualCancel.disabled = false;
  }
});

async function onBarcodeScanned(code) {
  if (!taskId) {
    setStatus(scanStatus, "אין TaskId. חזור למסך התחלה.", false);
    goStart();
    return;
  }

  pendingBarcode = code;
  localStorage.setItem(LS_LAST_BARCODE, pendingBarcode);
  setStatus(scanStatus, "ברקוד נקלט: " + pendingBarcode + " … מחפש מוצר", true);

  // We will NOT addLine yet. First show qty buttons.
  // But we still want a product preview. We'll "probe" by calling addLine with qty=1? לא.
  // So: simplest is to call addLine ONLY after qty selected,
  // and show a preview as "מוכן לבחירת כמות" without product data.
  // HOWEVER: your Apps Script currently finds product inside addLine,
  // so preview comes after choosing qty. That's fine.
  // We'll keep preview minimal:
  pendingProduct = null;
  productPreview.textContent = "ברקוד: " + pendingBarcode;
  buildQtyButtons();
  show(qtyPanel);
}

function buildQtyButtons() {
  qtyGrid.innerHTML = "";
  for (let i=1; i<=10; i++) {
    const b = document.createElement("button");
    b.textContent = String(i);
    b.addEventListener("click", () => pickQty(i));
    qtyGrid.appendChild(b);
  }
}

btnCancelQty.addEventListener("click", () => {
  pendingBarcode = "";
  pendingProduct = null;
  hide(qtyPanel);
  setStatus(scanStatus, "בוטל. סרוק שוב.", true);
  armScanner();
});

async function pickQty(qty) {
  // Disable all qty buttons while saving
  [...qtyGrid.querySelectorAll("button")].forEach(b => b.disabled = true);
  btnCancelQty.disabled = true;
  btnFinishFromScan.disabled = true;

  try {
    const { date, time } = getDateTimeParts();
    const data = await apiPost({
      action: "addLine",
      taskId,
      barcode: pendingBarcode,
      qty,
      scannedAtDate: date,
      scannedAtTime: time,
    });
    if (!data.ok) throw new Error(data.error || "addLine failed");

    const p = data.product || {};
    pendingProduct = p;

    setStatus(scanStatus, `נשמר ✅ ${p.name || ""} | כמות: ${qty}`, true);

    // Reset to scan again
    pendingBarcode = "";
    pendingProduct = null;
    hide(qtyPanel);
    armScanner();
  } catch (err) {
    setStatus(scanStatus, "שגיאה בשמירה: " + err.message, false);
    // Keep qty panel open so they can retry/cancel
  } finally {
    [...qtyGrid.querySelectorAll("button")].forEach(b => b.disabled = false);
    btnCancelQty.disabled = false;
    btnFinishFromScan.disabled = false;
  }
}

btnFinish.addEventListener("click", async () => {
  await openSummary();
});

btnFinishFromScan.addEventListener("click", async () => {
  await openSummary();
});

async function openSummary() {
  if (!taskId) { goStart(); return; }
  try {
    setStatus(scanStatus, "טוען סיכום…", true);
    const data = await apiGet({ action: "getTask", taskId });
    if (!data.ok) throw new Error(data.error || "getTask failed");
    const apiLines = Array.isArray(data.lines) ? data.lines : [];
    const manualLines = getManualLines(taskId);
    summaryLines = [...apiLines, ...manualLines];
    renderSummary(summaryLines);
    goSummary();
  } catch (err) {
    setStatus(scanStatus, "שגיאה בטעינת סיכום: " + err.message, false);
  }
}

function renderSummary(lines) {
  summaryTableBody.innerHTML = "";
  const showChecklist = (summarySort?.value || "warehouse") === "warehouse";
  const sorted = sortSummaryLines(lines);
  if (!sorted.length) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="${showChecklist ? 5 : 4}" class="muted">אין פריטים במשימה עדיין.</td>`;
    summaryTableBody.appendChild(tr);
    toggleChecklistColumn(showChecklist);
    return;
  }
  sorted.forEach((ln, index) => {
    const inventoryValue = String(ln.inventory ?? "").toUpperCase();
    const isFlagged = inventoryValue === "FALSE";
    const checklistValue = normalizeChecklist(ln.checklist);
    const tr = document.createElement("tr");
    tr.className = `summary-row${isFlagged ? " flagged" : ""}`;
    tr.tabIndex = 0;
    tr.dataset.index = String(ln.lineIndex ?? index);
    tr.dataset.lineId = String(ln.lineId ?? ln.id ?? ln.rowId ?? "");
    tr.dataset.barcode = String(ln.barcode ?? "");
    tr.dataset.inventory = isFlagged ? "FALSE" : "";
    tr.dataset.checklist = checklistValue ? "TRUE" : "";
    tr.innerHTML = `
      <td>${escapeHtml(String(ln.warehouseBin ?? ""))}</td>
      <td class="checklist-cell">
        <input type="checkbox" ${checklistValue ? "checked" : ""} aria-label="צ'קליסט" />
      </td>
      <td>${escapeHtml(ln.productName || "")}</td>
      <td class="qty-cell">${escapeHtml(String(ln.qty ?? ""))}</td>
      <td>${escapeHtml(String(ln.shelf ?? ""))}</td>
    `;
    const checklistInput = tr.querySelector("input[type=\"checkbox\"]");
    checklistInput.addEventListener("click", (event) => {
      event.stopPropagation();
    });
    checklistInput.addEventListener("change", async (event) => {
      event.stopPropagation();
      await updateChecklistStatus(tr, ln, event.target.checked);
      renderSummary(summaryLines);
    });
    const qtyCell = tr.querySelector(".qty-cell");
    qtyCell.addEventListener("click", (event) => {
      event.stopPropagation();
      openQtyEditModal(ln);
    });
    tr.addEventListener("click", () => promptInventoryToggle(tr, ln));
    tr.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        promptInventoryToggle(tr, ln);
      }
    });
    summaryTableBody.appendChild(tr);
  });
  toggleChecklistColumn(showChecklist);
}

btnAddMore.addEventListener("click", () => {
  goScan();
});

btnDone.addEventListener("click", async () => {
  show(finishConfirm);
});

finishConfirmNo.addEventListener("click", () => {
  hide(finishConfirm);
});

qtyEditCancel.addEventListener("click", () => {
  pendingQtyEdit = null;
  hide(qtyEditModal);
});

qtyEditSave.addEventListener("click", async () => {
  if (!pendingQtyEdit) return;
  const newQty = Number(qtyEditInput.value || 0);
  if (!Number.isFinite(newQty) || newQty < 1) {
    setStatus(summaryStatus, "כמות חייבת להיות מספר גדול מ-0", false);
    return;
  }
  qtyEditSave.disabled = true;
  qtyEditCancel.disabled = true;
  try {
    await updateQtyForLine(pendingQtyEdit, newQty);
    pendingQtyEdit = null;
    hide(qtyEditModal);
    renderSummary(summaryLines);
  } catch (err) {
    setStatus(summaryStatus, "שגיאה בעדכון כמות: " + err.message, false);
  } finally {
    qtyEditSave.disabled = false;
    qtyEditCancel.disabled = false;
  }
});

finishConfirmYes.addEventListener("click", async () => {
  if (!taskId) { goStart(); return; }

  finishConfirmYes.disabled = true;
  finishConfirmNo.disabled = true;
  btnDone.disabled = true;
  try {
    const data = await apiPost({ action: "finishTask", taskId });
    if (!data.ok) throw new Error(data.error || "finishTask failed");

    // Reset local
    removeTaskManualLines(taskId);
    localStorage.removeItem(LS_TASK_ID);
    localStorage.removeItem(LS_LAST_BARCODE);
    taskId = "";
    setStatus(summaryStatus, "המשימה נסגרה ואופסה ✅", true);
    goStart();
  } catch (err) {
    setStatus(summaryStatus, "שגיאה בסגירת משימה: " + err.message, false);
  } finally {
    hide(finishConfirm);
    finishConfirmYes.disabled = false;
    finishConfirmNo.disabled = false;
    btnDone.disabled = false;
  }
});

  /** =======================
 *  Numpad (manual input)
 *  ======================= */
function buildNumpad() {
  padGrid.innerHTML = "";

  // בונה כפתורים 1..9 ואז 0
  for (let i = 1; i <= 9; i++) addPadBtn(String(i));
  addPadBtn("0");

  function addPadBtn(label) {
    const b = document.createElement("button");
    b.textContent = label;
    b.addEventListener("click", () => {
      barcodeInput.value = (barcodeInput.value || "") + label;
    });
    padGrid.appendChild(b);
  }
}

padBack.addEventListener("click", () => {
  barcodeInput.value = (barcodeInput.value || "").slice(0, -1);
});

padClear.addEventListener("click", () => {
  barcodeInput.value = "";
});

padOk.addEventListener("click", () => {
  const code = (barcodeInput.value || "").trim();
  if (!code) return;
  hide(numpad);
  onBarcodeScanned(code);
});

padClose.addEventListener("click", () => {
  hide(numpad);
  armScanner();
});

summarySort.addEventListener("change", () => {
  renderSummary(summaryLines);
});

inventoryConfirmNo.addEventListener("click", () => {
  pendingInventoryToggle = null;
  hide(inventoryConfirm);
});

inventoryConfirmYes.addEventListener("click", async () => {
  if (!pendingInventoryToggle) return;
  const { rowEl, lineData, nextValue } = pendingInventoryToggle;
  inventoryConfirmYes.disabled = true;
  inventoryConfirmNo.disabled = true;
  try {
    await updateInventoryStatus(rowEl, lineData, nextValue);
    hide(inventoryConfirm);
  } finally {
    pendingInventoryToggle = null;
    inventoryConfirmYes.disabled = false;
    inventoryConfirmNo.disabled = false;
  }
});


/** =======================
 *  Utils
 *  ======================= */
function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function sortSummaryLines(lines) {
  const sortKey = summarySort?.value || "warehouse";
  const locale = "he";
  let filtered = [...lines];
  if (sortKey === "shelf") {
    filtered = filtered.filter((line) => normalizeChecklist(line.checklist));
  }
  const sorted = [...filtered];
  sorted.sort((a, b) => {
    if (sortKey === "warehouse") {
      const aMarked = normalizeChecklist(a.checklist);
      const bMarked = normalizeChecklist(b.checklist);
      if (aMarked !== bMarked) return aMarked ? 1 : -1;
    }
    const aVal = getSortValue(a, sortKey);
    const bVal = getSortValue(b, sortKey);
    return aVal.localeCompare(bVal, locale, { numeric: true, sensitivity: "base" });
  });
  return sorted;
}

function getSortValue(line, key) {
  switch (key) {
    case "shelf":
      return String(line.shelf ?? "");
    case "product":
      return String(line.productName ?? "");
    case "warehouse":
    default:
      return String(line.warehouseBin ?? "");
  }
}

function toggleChecklistColumn(visible) {
  if (!checklistHeader) return;
  checklistHeader.classList.toggle("hidden-column", !visible);
  const cells = summaryTableBody.querySelectorAll(".checklist-cell");
  cells.forEach((cell) => cell.classList.toggle("hidden-column", !visible));
}

function normalizeChecklist(value) {
  if (value === true) return true;
  if (value === false) return false;
  const normalized = String(value ?? "").toUpperCase();
  return normalized === "TRUE" || normalized === "YES" || normalized === "1" || normalized === "V";
}

function openQtyEditModal(lineData) {
  pendingQtyEdit = lineData;
  qtyEditTitle.textContent = `עריכת כמות עבור: ${lineData.productName || "מוצר"}`;
  qtyEditInput.value = String(lineData.qty ?? "");
  show(qtyEditModal);
  try { qtyEditInput.focus({ preventScroll: true }); } catch { qtyEditInput.focus(); }
}

async function updateQtyForLine(lineData, qty) {
  if (lineData.manual) {
    lineData.qty = qty;
    upsertManualLine(taskId, lineData);
    setStatus(summaryStatus, "כמות עודכנה ✅", true);
    return;
  }

  const lineId = String(lineData.lineId || lineData.id || lineData.rowId || "");
  const barcode = String(lineData.barcode || "");
  const lineIndex = String(lineData.lineIndex ?? lineData.index ?? "");

  const payload = {
    action: "updateLine",
    taskId,
    lineId,
    barcode,
    lineIndex,
    qty,
  };

  let data = await apiPost(payload);
  if (!data.ok) data = await apiPost({ ...payload, action: "setQty" });
  if (!data.ok) data = await apiPost({ ...payload, action: "updateQty" });
  if (!data.ok) throw new Error(data.error || "qty update failed");

  lineData.qty = qty;
  setStatus(summaryStatus, "כמות עודכנה ✅", true);
}

function promptInventoryToggle(rowEl, lineData) {
  const isFlagged = rowEl.dataset.inventory === "FALSE";
  const productName = lineData.productName || "המוצר";
  if (isFlagged) {
    inventoryConfirmText.textContent = `לבטל סימון של "${productName}" כנגמר במלאי?`;
    pendingInventoryToggle = { rowEl, lineData, nextValue: "" };
    inventoryConfirmYes.classList.add("confirm-yes-green");
  } else {
    inventoryConfirmText.textContent = `לעדכן שהפריט "${productName}" נגמר במחסן?`;
    pendingInventoryToggle = { rowEl, lineData, nextValue: "FALSE" };
    inventoryConfirmYes.classList.remove("confirm-yes-green");
  }
  show(inventoryConfirm);
}

async function updateInventoryStatus(rowEl, lineData, value) {
  const lineId = rowEl.dataset.lineId || lineData.lineId || lineData.id || lineData.rowId || "";
  const barcode = rowEl.dataset.barcode || lineData.barcode || "";
  const lineIndex = String(lineData.lineIndex ?? lineData.index ?? rowEl.dataset.index ?? "");

  if (lineData.manual) {
    if (value === "FALSE") {
      rowEl.classList.add("flagged");
      rowEl.dataset.inventory = "FALSE";
    } else {
      rowEl.classList.remove("flagged");
      rowEl.dataset.inventory = "";
    }
    lineData.inventory = value;
    upsertManualLine(taskId, lineData);
    return;
  }

  try {
    const payload = {
      action: "setInventory",
      taskId,
      lineId,
      barcode,
      lineIndex,
      inventory: value ?? "",
    };
    let data = await apiPost(payload);
    if (!data.ok) {
      data = await apiPost({ ...payload, action: "updateInventory" });
    }
    if (!data.ok) {
      data = await apiPost({ ...payload, action: "updateLine" });
    }
    if (!data.ok) throw new Error(data.error || "inventory update failed");

    if (value === "FALSE") {
      rowEl.classList.add("flagged");
      rowEl.dataset.inventory = "FALSE";
    } else {
      rowEl.classList.remove("flagged");
      rowEl.dataset.inventory = "";
    }
    lineData.inventory = value;
  } catch (err) {
    setStatus(summaryStatus, "שגיאה בעדכון מלאי: " + err.message, false);
  }
}

async function updateChecklistStatus(rowEl, lineData, checked) {
  const lineId = rowEl.dataset.lineId || lineData.lineId || lineData.id || lineData.rowId || "";
  const barcode = rowEl.dataset.barcode || lineData.barcode || "";
  const lineIndex = String(lineData.lineIndex ?? lineData.index ?? rowEl.dataset.index ?? "");
  const value = checked ? "TRUE" : "";

  if (lineData.manual) {
    lineData.checklist = value;
    rowEl.dataset.checklist = value ? "TRUE" : "";
    upsertManualLine(taskId, lineData);
    return;
  }

  try {
    const payload = {
      action: "setChecklist",
      taskId,
      lineId,
      barcode,
      lineIndex,
      checklist: value,
    };
    let data = await apiPost(payload);
    if (!data.ok) {
      data = await apiPost({ ...payload, action: "updateChecklist" });
    }
    if (!data.ok) {
      data = await apiPost({ ...payload, action: "updateLine" });
    }
    if (!data.ok) throw new Error(data.error || "checklist update failed");
    lineData.checklist = value;
    rowEl.dataset.checklist = value ? "TRUE" : "";
  } catch (err) {
    setStatus(summaryStatus, "שגיאה בעדכון צ'קליסט: " + err.message, false);
  }
}

/** =======================
 *  Boot
 *  ======================= */
(function init() {
  setTaskLabel(taskId);

  // If task exists, go scan, else start.
  if (taskId) goScan();
  else goStart();

  // Keep scanner armed when returning to tab
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden && !screenScan.classList.contains("hidden")) {
      armScanner();
    }
  });
})();

window.addEventListener("beforeinstallprompt", (event) => {
  event.preventDefault();
  deferredInstallPrompt = event;
  show(btnInstall);
});

window.addEventListener("appinstalled", () => {
  deferredInstallPrompt = null;
  hide(btnInstall);
});

if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js").catch(() => {});
  });
}
</script>
</body>
</html>
